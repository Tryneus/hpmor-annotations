window.activeNote=null;function annotate(){let t=document.getElementById('hpmor-annotations-frame'),e=t.contentDocument.getElementById('hpmor-annotations-notes');if(!t)console.error('hpmor-annotations: Could not find iframe.');else{let n=t.contentWindow.location.href,o=n.match(/\/([0-9]+)(\.html)?$/),a=o&&parseInt(o[1]),r=t.contentDocument.getElementById('storycontent');e?a?r?fetchAnnotations(a,n=>{let o=wrapContent(t.contentDocument,r);clearNotes(r,e);innerHTML=o.innerHTML.replace(/[\n ]+/g,' ');Object.values(n).forEach(t=>{innerHTML=innerHTML.replace(t.text,t.replacement)});o.innerHTML=innerHTML;addNotes(o,e,n)}):console.error('hpmor-annotations: Could not find story content.'):console.error('hpmor-annotations: Could not determine chapter.',n):console.error('hpmor-annotations: Could not find notes.')}}function wrapContent(t,e){t.getElementById('hpmor-annotations-wrapped-content')||(e.innerHTML=`
      <div style="flex: 1 1 300px"></div>
      <div id="hpmor-annotations-wrapped-content" style="flex: 0 0 auto; max-width: 42em">
        ${e.innerHTML}
      </div>
      <div style="flex: 1 3 300px"></div>`,e.style.display='flex',e.style['flex-direction']='vertical',e.style['margin-right']=null,e.style['margin-left']=null,e.style['max-width']='none');return t.getElementById('hpmor-annotations-wrapped-content')}function getAnnotationSpans(t){return Array.from(t.getElementsByTagName('span')).filter(t=>t.attributes.annotation&&t.attributes.annotation.value.match(/^hpmor-[0-9]+-[0-9]+$/))}function fetchAnnotations(t,e){let n=new XMLHttpRequest;n.open('GET',`https://tryneus.github.io/hpmor-annotations/dist/annotation/${t}.json`);n.send();n.onerror=()=>{console.error('hpmor-annotations: Could not load annotations.')};n.onload=()=>{n.status!==200?console.error('hpmor-annotations: Loading annotations failed, status:',n.status):e(parseAnnotations(n.response))}}function parseAnnotations(t){try{return JSON.parse(t)}catch(t){console.error('hpmor-annotations: Failed to parse annotations',t)}}function clearNotes(t,e){getAnnotationSpans(t).forEach(t=>{t.outerHTML=t.innerHTML});e.innerHTML=''}function addNotes(t,e,n){let o={'foreshadowing':'#aaa','consequence':'#f6f','reference':'#66f','departure':'#f90','original':'#af0','speculation':'#e0f','background':'#30f','spoiler':'#f00'};getAnnotationSpans(t).map(t=>{let e=t.attributes.annotation.value,a=n[e];if(!a){console.error('hpmor-annotations: Could not find annotation',e);return null}let r=o[a.tags[0]];t.style['text-decoration']=`dotted ${r} underline`;t.style.cursor='pointer';t.onclick=t=>toggleNote(e,t);return{annotation:a,span:t}});Object.values(n).forEach(t=>{let n=o[t.tags[0]],a=document.createElement('div');a.id=`${t.id}-note`;a.style.position='absolute';a.style.display='none';a.onclick=dismissNote;a.innerHTML=`
      <div style="display: flex; height: 100%; margin-left: 5px; cursor: default; justify-content: flex-end">
        <div>
          <div style="font: 600 15px PT\\ Sans, Georgia; font-variant: all-small-caps; border-radius: 5px 5px 0 0; background: ${n}; padding: 0 7px">${t.tags.join(' / ')}</div>
          <div style="border-radius: 0 0 5px 5px; background: #f0f0f0; border: 1px solid ${n}; font: 12px sans-serif; padding: 7px; flex-shrink: 0">${t.note}</div>
        </div>
        <div style="min-width: 3px; border-left: 2px solid ${n}; border-top: 2px solid ${n}; border-bottom: 2px solid ${n}; border-right: 2px solid #fff0; margin: 0 5px"></div>
      </div>`;e.appendChild(a)})}function getNoteDiv(t){return document.getElementById('hpmor-annotations-frame').contentDocument.getElementById(`${t}-note`)}function toggleNote(t,e){let n=getNoteDiv(t);e.preventDefault();e.stopPropagation();if(window.activeNote){if(window.activeNote!==n)dismissNote();else{dismissNote();return}}window.activeNote=n;n.style.display=null;positionNote()}function positionNote(){if(!window.activeNote){return}let t=window.activeNote.id.match(/^(hpmor-[0-9]+-[0-9]+)-note$/)[1],e=document.getElementById('hpmor-annotations-frame'),n=e.contentDocument.getElementById('hpmor-annotations-wrapped-content'),o=Array.from(e.contentDocument.getElementsByTagName('span')).filter(e=>e.attributes.annotation&&e.attributes.annotation.value===t),a=o.reduce((t,e)=>{let{top:n,bottom:o}=e.getBoundingClientRect();return{top:t&&(t.top<n?t.top:n)||n,bottom:t&&(t.bottom>o?t.bottom:o)||o}},{});window.activeNote.style.left='0px';window.activeNote.style.width=`${n.getBoundingClientRect().left+e.contentWindow.pageXOffset}px`;window.activeNote.style.top=`${a.top+e.contentWindow.pageYOffset}px`;window.activeNote.style.height=`${a.bottom-a.top}px`}function dismissNote(){window.activeNote.style.display='none';window.activeNote=null}function reloadScript(){let t=Array.from(document.getElementsByTagName('script')).filter(t=>Boolean(t.src.match(/\/annotate.js$/)));if(t.length===0)console.error('Could not find script to reload.');else if(t.length>1)console.error('Found too many matching script elements.',t);else{let e=t[0],n=document.createElement('script');n.src=e.src.replace('dist','src');e.parentNode.removeChild(e);document.body.appendChild(n)}}typeof module!=='undefined'&&module.exports&&(module.exports={annotate,fetchAnnotations,parseAnnotations,addNotes,reloadScript})