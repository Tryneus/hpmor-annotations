!function(){let t,e=window.location.hostname===''&&window.location.pathname.match(/\/chapter\/[0-9]+\.html$/),n={'foreshadowing':'#aaa','consequence':'#f6f','reference':'#77f','departure':'#f90','original':'#af0','speculation':'#e0f','background':'#30f','spoiler':'#f00'};function o(){let e=document.getElementById('hpmor-annotations-frame'),n=e.contentDocument;Array.from(n.getElementsByTagName('a')).map(t=>{t.target==='_top'&&(t.target='_self')});n.getElementById('nav-form-top').target='_self';window.history.replaceState({},'',e.contentWindow.location.href);document.title=n.title;t=null;d()}function a(){if(!document.getElementById('hpmor-annotations-frame')){while(document.body.children.length>0)document.body.removeChild(document.body.children[0]);let t=document.createElement('iframe');t.id='hpmor-annotations-frame';t.src=window.location.href;document.body.appendChild(t)}let t=document.getElementById('hpmor-annotations-frame');t.style.width='100vw';t.style.height='100vh';t.style.border='none';t.addEventListener('load',o);window.addEventListener('resize',y);return t}function r(t,e,n){t.data(e,'events').click.forEach(n=>{t(e).unbind('click',n.handler)});t(e).bind('click',n)}function i(t,e){let n=t.$,o=e.getElementById('smaller').firstChild,a=e.getElementById('original').firstChild,i=e.getElementById('bigger').firstChild;e.getElementById('storycontent').style=null;r(n,o,()=>{n('#storycontent').css('font-size','-=1'),n('.hpmor-annotations-note-tags').css('font-size','-=1'),n('.hpmor-annotations-note-text').css('font-size','-=1'),y()});r(n,a,()=>{n('#storycontent').css('font-size','16px'),n('.hpmor-annotations-note-tags').css('font-size','15px'),n('.hpmor-annotations-note-text').css('font-size','12px'),y()});r(n,i,()=>{n('#storycontent').css('font-size','+=1'),n('.hpmor-annotations-note-tags').css('font-size','+=1'),n('.hpmor-annotations-note-text').css('font-size','+=1'),y()});let s=e.getElementById('fullwidth').firstChild,l=e.getElementById('readwidth').firstChild;r(n,s,()=>{n('#hpmor-annotations-wrapped-content').css('max-width','98%'),n('#hpmor-annotations-left-panel').css('display','none'),n('#hpmor-annotations-right-panel').css('display','none'),y()});r(n,l,()=>{n('#hpmor-annotations-wrapped-content').css('max-width','42em'),n('#hpmor-annotations-left-panel').css('display','block'),n('#hpmor-annotations-right-panel').css('display','block'),y()})}function s(t,e){let o=t.getElementById('hpmor-annotations-notes');o&&o.parentNode.removeChild(o);let a=t.getElementById('invertable'),r=t.createElement('div');r.id='hpmor-annotations-notes';a.insertBefore(r,a.childNodes[0]);Object.values(e).forEach(t=>{let e=n[t.tags[0]],o=document.createElement('div');o.id=`${t.id}-note`;o.className='hpmor-annotations-note';o.onclick=E;o.innerHTML=`
        <div class="hpmor-annotations-note-content">
          <div class="hpmor-annotations-note-tags" style="background: ${e}">${t.tags.join(' / ')}</div>
          <div class="hpmor-annotations-note-text" style="border-color: ${e}">${t.note}</div>
        </div>
        <div class="hpmor-annotations-note-bracket" style="border-color: ${e}"></div>
      `;r.appendChild(o)})}function l(t,e){let o=t.getElementById('hpmor-annotations-ranges');o&&o.parentNode.removeChild(o);let a=t.getElementById('invertable'),r=t.createElement('div');r.id='hpmor-annotations-ranges';a.insertBefore(r,a.childNodes[0]);Object.values(e).forEach(t=>{let e=n[t.tags[0]],o=document.createElement('div');o.id=`${t.id}-range`;o.className='hpmor-annotations-range-container';o.innerHTML=`
        <div class="hpmor-annotations-range-box">
          <div class="hpmor-annotations-range-divider"></div>
          <div class="hpmor-annotations-range" style="background: ${e}"></div>
        </div>
      `;let a=o.getElementsByClassName('hpmor-annotations-range-box')[0];a.onclick=e=>u(t.id,e);r.appendChild(o)})}function m(t){return Array.from(t.getElementsByClassName('hpmor-annotations-span'))}function c(t,e){m(t).forEach(t=>{t.outerHTML=t.innerHTML});let o=t.innerHTML.replace(/[\n ]+/g,' ');Object.values(e).forEach(t=>{o=o.replace(t.text,t.replacement)});t.innerHTML=o;m(t).forEach(t=>{let o=t.attributes.annotation.value,a=e[o];if(!a){console.error('hpmor-annotations: Could not find annotation',o);return null}let r=n[a.tags[0]];t.style['text-decoration-color']=r;t.onclick=t=>u(o,t)})}function d(){let t=a();if(!t)console.error('hpmor-annotations: Could not find iframe.');else{let e=t.contentWindow.location.href,n=e.match(/\/([0-9]+)(\.html)?(\#.*)?$/),o=n&&parseInt(n[1]),a=t.contentDocument.getElementById('storycontent');o?a?f(t,o,({annotations:e,anchors:n})=>{p(t.contentDocument);let o=h(t.contentDocument,a);i(t.contentWindow,t.contentDocument);c(o,e);s(t.contentDocument,e);l(t.contentDocument,e);y()}):console.error('hpmor-annotations: Could not find story content.'):console.error('hpmor-annotations: Could not determine chapter.',e)}}function p(t){if(!t.getElementById('hpmor-annotations-css')){let e=t.createElement('style');e.id='hpmor-annotations-css';e.type='text/css';t.head.appendChild(e)}let e=t.getElementById('hpmor-annotations-css');e.innerHTML="\n  #storycontent {\n    display: flex;\n    flex-direction: row;\n    justify-content: center;\n    margin-left: unset;\n    margin-right: unset;\n    max-width: none;\n  }\n\n  #hpmor-annotations-wrapped-content {\n    flex: 0 0 auto;\n    max-width: 42em;\n  }\n\n  #hpmor-annotations-left-panel {\n    flex: 1 1 300px;\n  }\n\n  #hpmor-annotations-right-panel {\n    flex: 1 3 300px;\n  }\n\n  .hpmor-annotations-note {\n    position: absolute;\n    left: 0;\n    cursor: default;\n    display: none;\n    justify-content: flex-end;\n  }\n\n  .hpmor-annotations-note-content {\n    flex: 1 0 auto;\n    width: 75%;\n    padding-left: 5px;\n    display: flex;\n    flex-direction: column;\n  }\n\n  .hpmor-annotations-note-tags {\n    font: 600 15px \"PT Sans\", Georgia;\n    font-variant: all-small-caps;\n    border-radius: 5px 5px 0 0;\n    padding: 0 7px;\n  }\n\n  .hpmor-annotations-note-text {\n    border-radius: 0 0 5px 5px;\n    background: #f0f0f0;\n    border-width: 1px;\n    font: 12px sans-serif;\n    padding: 7px;\n    word-wrap: break-word;\n  }\n\n  .hpmor-annotations-note-bracket {\n    min-width: 3px;\n    border-style: solid;\n    border-width: 2px;\n    border-right-color: #fff0 !important;\n    margin: 0 5px;\n    flex: 0 0 auto;\n  }\n\n  .hpmor-annotations-range-container {\n    position: absolute;\n    height: 100%;\n    align-items: center;\n    justify-content: flex-end;\n    pointer-events: none;\n  }\n\n  .hpmor-annotations-range-box {\n    height: 100%;\n    display: flex;\n    flex-direction: column;\n    margin-left: 5px;\n    padding-left: 2px;\n    padding-right: 2px;\n    cursor: pointer;\n    pointer-events: auto;\n  }\n\n  .hpmor-annotations-range-divider {\n    flex: 0 0 1px;\n    background: white;\n  }\n\n  .hpmor-annotations-range {\n    flex: 1 0 auto;\n    width: 3px;\n  }\n\n  .hpmor-annotations-link {\n    text-decoration: none;\n  }\n\n  .hpmor-annotations-link:hover {\n    text-decoration: underline;\n  }\n\n  .hpmor-annotations-span {\n    text-decoration-style: dotted;\n    text-decoration-line: underline;\n    cursor: pointer;\n  }\n    "}function h(t,e){t.getElementById('hpmor-annotations-wrapped-content')||(e.innerHTML=`
        <div id="hpmor-annotations-left-panel"></div>
        <div id="hpmor-annotations-wrapped-content">
          ${e.innerHTML}
        </div>
        <div id="hpmor-annotations-right-panel"></div>`);return t.getElementById('hpmor-annotations-wrapped-content')}function f(t,n,o){let a=t.contentDocument.getElementById('hpmor-annotations-data');a&&a.parentNode.removeChild(a);let r=t.contentDocument.createElement('script');r.id='hpmor-annotations-data';e?(r.src=`../dist/annotation/${n}.js`):(r.src=`https://tryneus.github.io/hpmor-annotations/dist/annotation/${n}.js`);r.onload=()=>{o(t.contentWindow.hpmorAnnotationsData)};t.contentDocument.head.appendChild(r)}function g(t){return document.getElementById('hpmor-annotations-frame').contentDocument.getElementById(`${t}-note`)}function u(e,n){let o=g(e);n.preventDefault();n.stopPropagation();if(t){if(t!==o)E();else{E();return}}o.style.display='flex';t=o}function y(){let t=document.getElementById('hpmor-annotations-frame'),e=t.contentDocument.getElementById('hpmor-annotations-wrapped-content'),n=Array.from(t.contentDocument.getElementsByClassName('hpmor-annotations-note'));n.forEach(n=>{let o=n.id.match(/^(hpmor-[0-9]+-[0-9]+)-note$/)[1],a=t.contentDocument.getElementById(`${o}-range`),r=Array.from(t.contentDocument.getElementsByTagName('span')).filter(t=>t.attributes.annotation&&t.attributes.annotation.value===o),i=r.reduce((t,e)=>{let{top:n,bottom:o}=e.getBoundingClientRect();return{top:t&&(t.top<n?t.top:n)||n,bottom:t&&(t.bottom>o?t.bottom:o)||o}},{});n.style.width=`${e.getBoundingClientRect().left+t.contentWindow.pageXOffset}px`;n.style.top=`${i.top+t.contentWindow.pageYOffset}px`;n.style.height=`${i.bottom-i.top}px`;a.style.left=`${e.getBoundingClientRect().right+t.contentWindow.pageXOffset}px`;a.style.top=n.style.top;a.style.height=n.style.height})}function E(){if(!t){return}t.style.display=null;t=null}let B={installFrame:a,annotate:d};e&&(B.reloadScript=()=>{let t=document.getElementById('hpmor-annotations-script');if(!t)console.error('Could not find script to reload.');else{let e=document.getElementById('hpmor-annotations-frame');e.removeEventListener('load',o);window.removeEventListener('resize',y);let n=document.createElement('script');n.src=t.src.replace('dist','src');n.id='hpmor-annotations-script';t.parentNode.removeChild(t);document.head.appendChild(n)}});typeof module!=='undefined'&&module.exports?(module.exports=B):(window.hpmorAnnotations=B)}()