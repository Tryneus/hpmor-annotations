window.activeNote=null;function installCss(t){if(!t.getElementById('hpmor-annotations-css')){let n=t.createElement('style');n.id='hpmor-annotations-css';n.type='text/css';t.head.appendChild(n)}let n=t.getElementById('hpmor-annotations-css');console.log('setting innerhtml of',n);n.innerHTML="\n#storycontent {\n  display: flex;\n  flex-direction: row;\n  margin-left: unset;\n  margin-right: unset;\n  max-width: none;\n}\n\n#hpmor-annotations-wrapped-content {\n  flex: 0 0 auto;\n  max-width: 42em;\n}\n\n.hpmor-annotations-left-panel {\n  flex: 1 1 300px;\n}\n\n.hpmor-annotations-right-panel {\n  flex: 1 3 300px;\n}\n\n.hpmor-annotations-note {\n  position: absolute;\n  display: none;\n  left: 0;\n}\n\n.hpmor-annotations-note-container {\n  display: flex;\n  height: 100%;\n  margin-left: 5px;\n  cursor: default;\n  justify-content: flex-end;\n}\n\n.hpmor-annotations-note-tags {\n  font: 600 15px \"PT Sans\", Georgia;\n  font-variant: all-small-caps;\n  border-radius: 5px 5px 0 0;\n  padding: 0 7px;\n}\n\n.hpmor-annotations-note-text {\n  border-radius: 0 0 5px 5px;\n  background: #f0f0f0;\n  border-width: 1px;\n  font: 12px sans-serif;\n  padding: 7px;\n  flex-shrink: 0;\n}\n\n.hpmor-annotations-note-bracket {\n  min-width: 3px;\n  border-width: 2px;\n  border-right-color: #fff0;\n  margin: 0 5px;\n}\n\n.hpmor-annotations-link {\n  text-decoration: none;\n}\n\n.hpmor-annotations-link:hover {\n  text-decoration: underline;\n}\n\n.hpmor-annotations-span {\n  text-decoration-line: dotted;\n  text-decoration-style: underline;\n  cursor: pointer;\n}\n  "}function annotate(){let t=document.getElementById('hpmor-annotations-frame'),n=t.contentDocument.getElementById('hpmor-annotations-notes');if(!t)console.error('hpmor-annotations: Could not find iframe.');else{let e=t.contentWindow.location.href,o=e.match(/\/([0-9]+)(\.html)?$/),a=o&&parseInt(o[1]),r=t.contentDocument.getElementById('storycontent');n?a?r?fetchAnnotations(a,e=>{installCss(t.contentDocument);let o=wrapContent(t.contentDocument,r);clearNotes(r,n);innerHTML=o.innerHTML.replace(/[\n ]+/g,' ');Object.values(e).forEach(t=>{innerHTML=innerHTML.replace(t.text,t.replacement)});o.innerHTML=innerHTML;addNotes(o,n,e)}):console.error('hpmor-annotations: Could not find story content.'):console.error('hpmor-annotations: Could not determine chapter.',e):console.error('hpmor-annotations: Could not find notes.')}}function wrapContent(t,n){t.getElementById('hpmor-annotations-wrapped-content')||(n.innerHTML=`
      <div class="hpmor-annotations-left-panel"></div>
      <div id="hpmor-annotations-wrapped-content">
        ${n.innerHTML}
      </div>
      <div class="hpmor-annotations-right-panel"></div>`);return t.getElementById('hpmor-annotations-wrapped-content')}function getAnnotationSpans(t){return Array.from(t.getElementsByTagName('span')).filter(t=>t.attributes.annotation&&t.attributes.annotation.value.match(/^hpmor-[0-9]+-[0-9]+$/))}function fetchAnnotations(t,n){let e=new XMLHttpRequest;e.open('GET',`https://tryneus.github.io/hpmor-annotations/dist/annotation/${t}.json`);e.send();e.onerror=()=>{console.error('hpmor-annotations: Could not load annotations.')};e.onload=()=>{e.status!==200?console.error('hpmor-annotations: Loading annotations failed, status:',e.status):n(parseAnnotations(e.response))}}function parseAnnotations(t){try{return JSON.parse(t)}catch(t){console.error('hpmor-annotations: Failed to parse annotations',t)}}function clearNotes(t,n){getAnnotationSpans(t).forEach(t=>{t.outerHTML=t.innerHTML});n.innerHTML=''}function addNotes(t,n,e){let o={'foreshadowing':'#aaa','consequence':'#f6f','reference':'#66f','departure':'#f90','original':'#af0','speculation':'#e0f','background':'#30f','spoiler':'#f00'};getAnnotationSpans(t).map(t=>{let n=t.attributes.annotation.value,a=e[n];if(!a){console.error('hpmor-annotations: Could not find annotation',n);return null}let r=o[a.tags[0]];t.style['text-decoration-color']=r;t.onclick=t=>toggleNote(n,t);return{annotation:a,span:t}});Object.values(e).forEach(t=>{let e=o[t.tags[0]],a=document.createElement('div');a.id=`${t.id}-note`;a.className='hpmor-annotations-note';a.onclick=dismissNote;a.innerHTML=`
      <div class="hpmor-annotations-note-container">
        <div>
          <div class="hpmor-annotations-note-tags" style="background: ${e}">${t.tags.join(' / ')}</div>
          <div class="hpmor-annotations-note-text" style="border-color: ${e}">${t.note}</div>
        </div>
        <div class="hpmor-annotations-note-bracket" style="border-color: ${e}"></div>
      </div>`;n.appendChild(a)})}function getNoteDiv(t){return document.getElementById('hpmor-annotations-frame').contentDocument.getElementById(`${t}-note`)}function toggleNote(t,n){let e=getNoteDiv(t);n.preventDefault();n.stopPropagation();if(window.activeNote){if(window.activeNote!==e)dismissNote();else{dismissNote();return}}window.activeNote=e;e.style.display='block';positionNote()}function positionNote(){if(!window.activeNote){return}let t=window.activeNote.id.match(/^(hpmor-[0-9]+-[0-9]+)-note$/)[1],n=document.getElementById('hpmor-annotations-frame'),e=n.contentDocument.getElementById('hpmor-annotations-wrapped-content'),o=Array.from(n.contentDocument.getElementsByTagName('span')).filter(n=>n.attributes.annotation&&n.attributes.annotation.value===t),a=o.reduce((t,n)=>{let{top:e,bottom:o}=n.getBoundingClientRect();return{top:t&&(t.top<e?t.top:e)||e,bottom:t&&(t.bottom>o?t.bottom:o)||o}},{});window.activeNote.style.width=`${e.getBoundingClientRect().left+n.contentWindow.pageXOffset}px`;window.activeNote.style.top=`${a.top+n.contentWindow.pageYOffset}px`;window.activeNote.style.height=`${a.bottom-a.top}px`}function dismissNote(){window.activeNote.style.display=null;window.activeNote=null}function reloadScript(){let t=Array.from(document.getElementsByTagName('script')).filter(t=>Boolean(t.src.match(/\/annotate.js$/)));if(t.length===0)console.error('Could not find script to reload.');else if(t.length>1)console.error('Found too many matching script elements.',t);else{let n=t[0],e=document.createElement('script');e.src=n.src.replace('dist','src');n.parentNode.removeChild(n);document.body.appendChild(e)}}typeof module!=='undefined'&&module.exports&&(module.exports={annotate,fetchAnnotations,parseAnnotations,addNotes,reloadScript})