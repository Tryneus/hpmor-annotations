function annotate(){let t=document.getElementById('hpmor-annotations-frame'),n=t.contentDocument.getElementById('hpmor-annotations-notes');if(!t)console.error('hpmor-annotations: Could not find iframe.');else{let e=t.contentWindow.location.href,o=e.match(/\/([0-9]+)(\.html)?$/),r=o&&parseInt(o[1]),a=t.contentDocument.getElementById('storycontent');n?r?a?fetchAnnotations(r,t=>{clearNotes(a,n),innerHTML=a.innerHTML.replace(/[\n ]+/g,' '),Object.values(t).forEach(t=>{innerHTML=innerHTML.replace(t.text,t.replacement)}),a.innerHTML=innerHTML,addNotes(a,n,t)}):console.error('hpmor-annotations: Could not find story content.'):console.error('hpmor-annotations: Could not determine chapter.',e):console.error('hpmor-annotations: Could not find notes.')}}function getAnnotationSpans(t){return Array.from(t.getElementsByTagName('span')).filter(t=>t.attributes.annotation&&t.attributes.annotation.value.match(/^hpmor-[0-9]+-[0-9]+$/))}function fetchAnnotations(t,n){let e=new XMLHttpRequest;e.open('GET',`https://tryneus.github.io/hpmor-annotations/dist/annotation/${t}.json`);e.send();e.onerror=()=>{console.error('hpmor-annotations: Could not load annotations.')};e.onload=()=>{e.status!==200?console.error('hpmor-annotations: Loading annotations failed, status:',e.status):n(parseAnnotations(e.response))}}function parseAnnotations(t){try{return JSON.parse(t)}catch(t){console.error('hpmor-annotations: Failed to parse annotations',t)}}function clearNotes(t,n){getAnnotationSpans(t).forEach(t=>{t.outerHTML=t.innerHTML});n.innerHTML=''}function addNotes(t,n,e){let o={'foreshadowing':'#888','consequence':'#f6f','reference':'#66f','departure':'#f90','original':'#6f0','speculation':'#e0f','background':'#30f','spoiler':'#f00'};getAnnotationSpans(t).map(t=>{let n=t.attributes.annotation.value,r=e[n];if(!r){console.error('hpmor-annotations: Could not find annotation',n);return null}let a=o[r.tags[0]];t.style['text-decoration']=`dotted ${a} underline`;t.onclick=toggleNote;return{annotation:r,span:t}});Object.values(e).forEach(t=>{let e=document.createElement('div');e.id=`${t.id}-note`;e.style.position='absolute';e.style.display='none';e.onclick=()=>e.style.display='none';e.innerHTML=`
      <div style="position: absolute;right: 0;">
        <div style="font: all-small-caps 600 15px PT\\ Sans, Georgia;">${t.tags.join(' ')}</div>
        <div>${t.note}</div>
      </div>`;n.appendChild(e)})}function getNoteDiv(t){return document.getElementById('hpmor-annotations-frame').contentDocument.getElementById(`${t}-note`)}function toggleNote(t){t.preventDefault();t.stopPropagation();let n=t.currentTarget,e=n.attributes.annotation.value,o=getNoteDiv(e);activeNote=e;o.style.display=null;positionNote(o,e)}function positionNote(t,n){let e=document.getElementById('hpmor-annotations-frame'),o=e.contentDocument.getElementById('storycontent'),r=Array.from(e.contentDocument.getElementsByTagName('span')).filter(t=>t.attributes.annotation&&t.attributes.annotation.value===n),a=r.reduce((t,n)=>{let{top:e,bottom:o}=n.getBoundingClientRect();return{top:t&&(t.top<e?t.top:e)||e,bottom:t&&(t.bottom>o?t.bottom:o)||o}},{});t.style.left='0px';t.style.width=`${o.getBoundingClientRect().left+e.contentWindow.pageXOffset}px`;t.style.top=`${a.top+e.contentWindow.pageYOffset}px`;t.style.height=`${a.bottom-a.top}px`}function reloadScript(){let t=Array.from(document.getElementsByTagName('script')).filter(t=>Boolean(t.src.match(/\/annotate.js$/)));if(t.length===0)console.error('Could not find script to reload.');else if(t.length>1)console.error('Found too many matching script elements.',t);else{let n=t[0],e=document.createElement('script');e.src=n.src.replace('dist','src');n.parentNode.removeChild(n);document.body.appendChild(e)}}typeof module!=='undefined'&&module.exports&&(module.exports={annotate,fetchAnnotations,parseAnnotations,addNotes,reloadScript})