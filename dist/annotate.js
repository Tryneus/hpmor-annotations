!function(){let t,e={'foreshadowing':'#aaa','consequence':'#f6f','reference':'#66f','departure':'#f90','original':'#af0','speculation':'#e0f','background':'#30f','spoiler':'#f00'};function n(){let e=document.getElementById('hpmor-annotations-frame'),n=e.contentDocument;Array.from(n.getElementsByTagName('a')).map(t=>{t.target==='_top'&&(t.target='_self')});n.getElementById('nav-form-top').target='_self';window.history.replaceState({},'',e.contentWindow.location.href);document.title=n.title;t=null;i()}function o(){if(!document.getElementById('hpmor-annotations-frame')){while(document.body.children.length>0)document.body.removeChild(document.body.children[0]);let t=document.createElement('iframe');t.id='hpmor-annotations-frame';t.src=window.location.href;document.body.appendChild(t)}let t=document.getElementById('hpmor-annotations-frame');t.style.width='100vw';t.style.height='100vh';t.style.border='none';t.addEventListener('load',n);window.addEventListener('resize',f);return t}function a(t,n){let o=t.getElementById('hpmor-annotations-notes');o&&o.parentNode.removeChild(o);let a=t.createElement('div');a.id='hpmor-annotations-notes';t.body.insertBefore(a,t.body.childNodes[0]);Object.values(n).forEach(t=>{let n=e[t.tags[0]],o=document.createElement('div');o.id=`${t.id}-note`;o.className='hpmor-annotations-note';o.onclick=h;o.innerHTML=`
        <div class="hpmor-annotations-note-content">
          <div class="hpmor-annotations-note-tags" style="background: ${n}">${t.tags.join(' / ')}</div>
          <div class="hpmor-annotations-note-text" style="border-color: ${n}">${t.note}</div>
        </div>
        <div class="hpmor-annotations-note-bracket" style="border-color: ${n}"></div>
      `;a.appendChild(o)})}function r(t,n){c(t).forEach(t=>{t.outerHTML=t.innerHTML});let o=t.innerHTML.replace(/[\n ]+/g,' ');Object.values(n).forEach(t=>{o=o.replace(t.text,t.replacement)});t.innerHTML=o;c(t).forEach(t=>{let o=t.attributes.annotation.value,a=n[o];if(!a){console.error('hpmor-annotations: Could not find annotation',o);return null}let r=e[a.tags[0]];t.style['text-decoration-color']=r;t.onclick=t=>u(o,t)})}function i(){let t=o();if(!t)console.error('hpmor-annotations: Could not find iframe.');else{let e=t.contentWindow.location.href,n=e.match(/\/([0-9]+)(\.html)?$/),o=n&&parseInt(n[1]),i=t.contentDocument.getElementById('storycontent');o?i?l(o,e=>{s(t.contentDocument);let n=m(t.contentDocument,i);r(n,e);a(t.contentDocument,e)}):console.error('hpmor-annotations: Could not find story content.'):console.error('hpmor-annotations: Could not determine chapter.',e)}}function s(t){if(!t.getElementById('hpmor-annotations-css')){let e=t.createElement('style');e.id='hpmor-annotations-css';e.type='text/css';t.head.appendChild(e)}let e=t.getElementById('hpmor-annotations-css');e.innerHTML="\n  #storycontent {\n    display: flex;\n    flex-direction: row;\n    margin-left: unset;\n    margin-right: unset;\n    max-width: none;\n  }\n\n  #hpmor-annotations-wrapped-content {\n    flex: 0 0 auto;\n    max-width: 42em;\n  }\n\n  .hpmor-annotations-left-panel {\n    flex: 1 1 300px;\n  }\n\n  .hpmor-annotations-right-panel {\n    flex: 1 3 300px;\n  }\n\n  .hpmor-annotations-note {\n    position: absolute;\n    display: none;\n    left: 0;\n    cursor: default;\n    justify-content: flex-end;\n  }\n\n  .hpmor-annotations-note-content {\n    flex: 1 0 auto;\n    width: 75%;\n    padding-left: 5px;\n    display: flex;\n    flex-direction: column;\n  }\n\n  .hpmor-annotations-note-tags {\n    font: 600 15px \"PT Sans\", Georgia;\n    font-variant: all-small-caps;\n    border-radius: 5px 5px 0 0;\n    padding: 0 7px;\n  }\n\n  .hpmor-annotations-note-text {\n    border-radius: 0 0 5px 5px;\n    background: #f0f0f0;\n    border-width: 1px;\n    font: 12px sans-serif;\n    padding: 7px;\n    word-wrap: break-word;\n  }\n\n  .hpmor-annotations-note-bracket {\n    min-width: 3px;\n    border-style: solid;\n    border-width: 2px;\n    border-right-color: #fff0 !important;\n    margin: 0 5px;\n    flex: 0 0 auto;\n  }\n\n  .hpmor-annotations-link {\n    text-decoration: none;\n  }\n\n  .hpmor-annotations-link:hover {\n    text-decoration: underline;\n  }\n\n  .hpmor-annotations-span {\n    text-decoration-style: dotted;\n    text-decoration-line: underline;\n    cursor: pointer;\n  }\n    "}function m(t,e){t.getElementById('hpmor-annotations-wrapped-content')||(e.innerHTML=`
        <div class="hpmor-annotations-left-panel"></div>
        <div id="hpmor-annotations-wrapped-content">
          ${e.innerHTML}
        </div>
        <div class="hpmor-annotations-right-panel"></div>`);return t.getElementById('hpmor-annotations-wrapped-content')}function c(t){return Array.from(t.getElementsByTagName('span')).filter(t=>t.attributes.annotation&&t.attributes.annotation.value.match(/^hpmor-[0-9]+-[0-9]+$/))}function l(t,e){let n=new XMLHttpRequest;n.open('GET',`https://tryneus.github.io/hpmor-annotations/dist/annotation/${t}.json`);n.send();n.onerror=()=>{console.error('hpmor-annotations: Could not load annotations.')};n.onload=()=>{n.status!==200?console.error('hpmor-annotations: Loading annotations failed, status:',n.status):e(d(n.response))}}function d(t){try{return JSON.parse(t)}catch(t){console.error('hpmor-annotations: Failed to parse annotations',t)}}function p(t){return document.getElementById('hpmor-annotations-frame').contentDocument.getElementById(`${t}-note`)}function u(e,n){let o=p(e);n.preventDefault();n.stopPropagation();if(t){if(t!==o)h();else{h();return}}t=o;o.style.display='flex';f()}function f(){console.log('positionNote',t);if(!t){return}let e=t.id.match(/^(hpmor-[0-9]+-[0-9]+)-note$/)[1],n=document.getElementById('hpmor-annotations-frame'),o=n.contentDocument.getElementById('hpmor-annotations-wrapped-content'),a=Array.from(n.contentDocument.getElementsByTagName('span')).filter(t=>t.attributes.annotation&&t.attributes.annotation.value===e),r=a.reduce((t,e)=>{let{top:n,bottom:o}=e.getBoundingClientRect();return{top:t&&(t.top<n?t.top:n)||n,bottom:t&&(t.bottom>o?t.bottom:o)||o}},{});t.style.width=`${o.getBoundingClientRect().left+n.contentWindow.pageXOffset}px`;t.style.top=`${r.top+n.contentWindow.pageYOffset}px`;t.style.height=`${r.bottom-r.top}px`}function h(){t.style.display=null;t=null}function g(){let t=document.getElementById('hpmor-annotations-script');if(!t)console.error('Could not find script to reload.');else{let e=document.getElementById('hpmor-annotations-frame');e.removeEventListener('load',n);window.removeEventListener('resize',f);let o=document.createElement('script');o.src=t.src.replace('dist','src');o.id='hpmor-annotations-script';t.parentNode.removeChild(t);document.head.appendChild(o)}}let y={installFrame:o,annotate:i,reloadScript:g};typeof module!=='undefined'&&module.exports?(module.exports=y):(window.hpmorAnnotations=y)}()