!function(){let t,e=!0,n=window.location.hostname===''&&window.location.pathname.match(/\/chapter\/[0-9]+\.html$/),o={'foreshadowing':'#aaa','consequence':'#fbf','reference':'#77f','departure':'#f90','original':'#9e5','speculation':'#fbf','background':'#30f','spoiler':'#f00','default':'#0000'};Object.keys(o);function a(t){let n=t.notes.filter(t=>e||!t.tags.includes('spoiler'));return n[0]&&n[0].tags[0]||'default'}function r(){let e=document.getElementById('hpmor-annotations-frame'),n=e.contentDocument;Array.from(n.getElementsByTagName('a')).map(t=>{t.target==='_top'&&(t.target='_self')});n.getElementById('nav-form-top').target='_self';window.history.replaceState({},'',e.contentWindow.location.href);document.title=n.title;t=null;f()}function i(){let t=document.getElementById('hpmor-annotations-frame');window.location.replace(t.contentWindow.location.href)}function s(){if(!document.getElementById('hpmor-annotations-frame')){while(document.body.children.length>0)document.body.removeChild(document.body.children[0]);let t=document.createElement('iframe');t.id='hpmor-annotations-frame';t.src=window.location.href;document.body.appendChild(t)}let t=document.getElementById('hpmor-annotations-frame');t.style.width='100vw';t.style.height='100vh';t.style.border='none';t.addEventListener('load',r);window.addEventListener('resize',I);window.addEventListener('beforeunload',i);return t}function l(t,e,n){t.data(e,'events').click.forEach(n=>{t(e).unbind('click',n.handler)});t(e).bind('click',n)}function m(t,e){let n=t.$,o=e.getElementById('smaller').firstChild,a=e.getElementById('original').firstChild,r=e.getElementById('bigger').firstChild;e.getElementById('storycontent').style=null;l(n,o,()=>{n('#storycontent').css('font-size','-=1'),n('.hpmor-annotations-note-tags').css('font-size','-=1'),n('.hpmor-annotations-note-text').css('font-size','-=1'),I()});l(n,a,()=>{n('#storycontent').css('font-size','16px'),n('.hpmor-annotations-note-tags').css('font-size','15px'),n('.hpmor-annotations-note-text').css('font-size','12px'),I()});l(n,r,()=>{n('#storycontent').css('font-size','+=1'),n('.hpmor-annotations-note-tags').css('font-size','+=1'),n('.hpmor-annotations-note-text').css('font-size','+=1'),I()});let i=e.getElementById('fullwidth').firstChild,s=e.getElementById('readwidth').firstChild;l(n,i,()=>{n('#hpmor-annotations-wrapped-content').css('max-width','98%'),n('#hpmor-annotations-left-panel').css('display','none'),n('#hpmor-annotations-right-panel').css('display','none'),I()});l(n,s,()=>{n('#hpmor-annotations-wrapped-content').css('max-width','42em'),n('#hpmor-annotations-left-panel').css('display','block'),n('#hpmor-annotations-right-panel').css('display','block'),I()})}function c(t,n){let r=t.getElementById('hpmor-annotations-notes');r&&r.parentNode.removeChild(r);let i=t.getElementById('invertable'),s=t.createElement('div');s.id='hpmor-annotations-notes';i.insertBefore(s,i.childNodes[0]);Object.values(n).forEach(t=>{let n=o[a(t)],r=document.createElement('div');r.id=`${t.id}-note`;r.className='hpmor-annotations-note';r.onclick=v;let i=t.notes.filter(t=>e||!t.tags.includes('spoiler')),l=Array.from(new Set(i.reduce((t,e)=>t.concat(e.tags),[]))).join(' / '),m=i.map(t=>`
        <p>${t.note}</p>
      `).join('\n');r.innerHTML=`
        <div class="hpmor-annotations-note-content">
          <div class="hpmor-annotations-note-tags" style="background: ${n}">${l}</div>
          <div class="hpmor-annotations-note-text" style="border-color: ${n}">${m}</div>
        </div>
        <div class="hpmor-annotations-note-bracket" style="border-color: ${n}"></div>
      `;s.appendChild(r)})}function d(t,e){let n=t.getElementById('hpmor-annotations-ranges');n&&n.parentNode.removeChild(n);let r=t.getElementById('invertable'),i=t.createElement('div');i.id='hpmor-annotations-ranges';r.insertBefore(i,r.childNodes[0]);Object.values(e).forEach(t=>{let e=o[a(t)],n=document.createElement('div');n.id=`${t.id}-range`;n.className='hpmor-annotations-range-container';n.innerHTML=`
        <div class="hpmor-annotations-range-box">
          <div class="hpmor-annotations-range-divider"></div>
          <div class="hpmor-annotations-range" style="background: ${e}"></div>
        </div>
      `;let r=n.getElementsByClassName('hpmor-annotations-range-box')[0];r.onclick=e=>B(t.id,e);i.appendChild(n)})}function p(t){return Array.from(t.getElementsByClassName('hpmor-annotations-span'))}function h(t,e){p(t).forEach(t=>{t.outerHTML=t.innerHTML});let n=t.innerHTML.replace(/[\n ]+/g,' ');Object.values(e).forEach(t=>{n=n.replace(t.text,t.replacement)});t.innerHTML=n;p(t).forEach(t=>{let n=t.attributes.annotation.value,r=e[n];if(!r){console.error('hpmor-annotations: Could not find annotation',n);return null}let i=o[a(r)];t.style['text-decoration-color']=i;t.onclick=t=>B(n,t)})}function f(){let t=s();if(!t)console.error('hpmor-annotations: Could not find iframe');else{let e=t.contentWindow.location.href,n=e.match(/\/([0-9]+)(\.html)?(#.*)?$/),o=n&&parseInt(n[1]),a=t.contentDocument.getElementById('storycontent');o?a?y(t,o,({annotations:e})=>{g(t.contentDocument);let n=u(t.contentDocument,a);m(t.contentWindow,t.contentDocument);h(n,e);c(t.contentDocument,e);d(t.contentDocument,e);I()}):console.error('hpmor-annotations: Could not find story content'):console.error('hpmor-annotations: Could not determine chapter',e)}}function g(t){if(!t.getElementById('hpmor-annotations-css')){let e=t.createElement('style');e.id='hpmor-annotations-css';e.type='text/css';t.head.appendChild(e)}let e=t.getElementById('hpmor-annotations-css');e.innerHTML="\n  #storycontent {\n    display: flex;\n    flex-direction: row;\n    justify-content: center;\n    margin-left: unset;\n    margin-right: unset;\n    max-width: none;\n  }\n\n  #hpmor-annotations-wrapped-content {\n    flex: 0 0 auto;\n    max-width: 42em;\n  }\n\n  #hpmor-annotations-left-panel {\n    flex: 1 1 300px;\n  }\n\n  #hpmor-annotations-right-panel {\n    flex: 1 3 300px;\n  }\n\n  .hpmor-annotations-note {\n    position: absolute;\n    left: 0;\n    cursor: default;\n    display: none;\n    justify-content: flex-end;\n  }\n\n  .hpmor-annotations-note-content {\n    flex: 1 0 auto;\n    width: 75%;\n    padding-left: 5px;\n    display: flex;\n    flex-direction: column;\n    word-wrap: break-word;\n  }\n\n  .hpmor-annotations-note-tags {\n    font: 600 15px \"PT Sans\", Georgia;\n    font-variant: all-small-caps;\n    border-radius: 5px 5px 0 0;\n    padding: 0 7px;\n  }\n\n  .hpmor-annotations-note-text {\n    border-radius: 0 0 5px 5px;\n    background: #f0f0f0;\n    border-width: 1px;\n    font: 12px sans-serif;\n    padding: 0px 7px;\n  }\n\n  .hpmor-annotations-note-bracket {\n    min-width: 3px;\n    border-style: solid;\n    border-width: 2px;\n    border-right-color: #fff0 !important;\n    margin: 0 5px;\n    flex: 0 0 auto;\n  }\n\n  .hpmor-annotations-range-container {\n    position: absolute;\n    height: 100%;\n    align-items: center;\n    justify-content: flex-end;\n    pointer-events: none;\n  }\n\n  .hpmor-annotations-range-box {\n    height: 100%;\n    display: flex;\n    flex-direction: column;\n    margin-left: 5px;\n    padding-left: 2px;\n    padding-right: 2px;\n    cursor: pointer;\n    pointer-events: auto;\n  }\n\n  .hpmor-annotations-range-divider {\n    flex: 0 0 1px;\n    background: white;\n  }\n\n  .hpmor-annotations-range {\n    flex: 1 0 auto;\n    width: 3px;\n  }\n\n  .hpmor-annotations-link {\n    text-decoration: none;\n  }\n\n  .hpmor-annotations-link:hover {\n    text-decoration: underline;\n  }\n\n  .hpmor-annotations-span {\n    text-decoration-style: dotted;\n    text-decoration-line: underline;\n    cursor: pointer;\n  }\n    "}function u(t,e){t.getElementById('hpmor-annotations-wrapped-content')||(e.innerHTML=`
        <div id="hpmor-annotations-left-panel"></div>
        <div id="hpmor-annotations-wrapped-content">
          ${e.innerHTML}
        </div>
        <div id="hpmor-annotations-right-panel"></div>`);return t.getElementById('hpmor-annotations-wrapped-content')}function y(t,e,o){let a=t.contentDocument.getElementById('hpmor-annotations-data');a&&a.parentNode.removeChild(a);let r=t.contentDocument.createElement('script');r.id='hpmor-annotations-data';n?(r.src=`../dist/annotation/${e}.js`):(r.src=`https://tryneus.github.io/hpmor-annotations/dist/annotation/${e}.js`);r.onload=()=>{o(t.contentWindow.hpmorAnnotationsData)};t.contentDocument.head.appendChild(r)}function E(t){return document.getElementById('hpmor-annotations-frame').contentDocument.getElementById(`${t}-note`)}function B(e,n){let o=E(e);n.preventDefault();n.stopPropagation();if(t){if(t!==o)v();else{v();return}}o.style.display='flex';t=o}function I(){let t=document.getElementById('hpmor-annotations-frame'),e=t.contentDocument.getElementById('hpmor-annotations-wrapped-content'),n=Array.from(t.contentDocument.getElementsByClassName('hpmor-annotations-note'));n.forEach(n=>{let o=n.id.match(/^(hpmor-[0-9]+-[0-9]+)-note$/)[1],a=t.contentDocument.getElementById(`${o}-range`),r=Array.from(t.contentDocument.getElementsByTagName('span')).filter(t=>t.attributes.annotation&&t.attributes.annotation.value===o),i=r.reduce((t,e)=>{let{top:n,bottom:o}=e.getBoundingClientRect();return{top:t&&(t.top<n?t.top:n)||n,bottom:t&&(t.bottom>o?t.bottom:o)||o}},{});i.top&&i.bottom?(n.style.width=`${e.getBoundingClientRect().left+t.contentWindow.pageXOffset}px`,n.style.top=`${i.top+t.contentWindow.pageYOffset}px`,n.style.height=`${i.bottom-i.top}px`,a.style.left=`${e.getBoundingClientRect().right+t.contentWindow.pageXOffset}px`,a.style.top=n.style.top,a.style.height=n.style.height):(console.error('hpmor-annotations: Could not find span for annotation',o),n.style.display='none',a.style.display='none')})}function v(){if(!t){return}t.style.display=null;t=null}let b={installFrame:s,annotate:f};n&&(b.reloadScript=()=>{let t=document.getElementById('hpmor-annotations-script');if(!t)console.error('Could not find script to reload.');else{let e=document.getElementById('hpmor-annotations-frame');e.removeEventListener('load',r);window.removeEventListener('resize',I);window.removeEventListener('beforeunload',i);let n=document.createElement('script');n.src=t.src.replace('dist','src');n.id='hpmor-annotations-script';t.parentNode.removeChild(t);document.head.appendChild(n)}});typeof module!=='undefined'&&module.exports?(module.exports=b):(window.hpmorAnnotations=b)}()